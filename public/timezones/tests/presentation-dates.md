## Retour vers le futur

Est-ce que quelqu'un peut me dire quel jour on est aujourd'hui ? (parce que je n'ai aucune m√©moire, je ne me rappelle jamais de la date)

Ah mince, on est le XX XXX XXXX ? Excusez-moi il faut que j'appelle ma belle-s≈ìur, c'est son anniversaire ! Elle vit √† Tahiti. Ha ben non, mince, chez elle on est encore hier ? Ou d√©j√† demain peut-√™tre ? ü§î

### Qu'est-ce qu'une date exactement ?

Une date, c'est un moyen de se rep√©rer dans le temps. C'est g√©n√©ralement assez pratique pour se synchroniser quand on est plusieurs : je suis n√© le 10 d√©cembre 1985 √† 0h30. Tout le monde comprend √ßa.

Une date c'est donc :

- une ann√©e,
- un mois,
- un jour,
- une heure,
- une minute,
- une seconde et un milliseconde si on veut √™tre (tr√®s) pr√©cis,
- [reveal] un fuseau horaire !
- [reveal] une calendrier !! et oui, si mon r√©f√©renciel c'est le calendrier h√©bra√Øque, on ne va pas **du tout** √™tre synchro !

On peut, parfois, ignorer certaine donn√©e, car elle sont "naturelle" en fonction du contexte:

- Venez mangez dimanche 20 novembre 2022 √† 12 heure 00, heure de Paris dans le calendrier Gr√©gorien‚Ä¶ Enfin venez manger ce dimanche midi quoi !

Voila, c'est tout, merci d'√™tre venu !

Sauf, qu'en fait, c'est un peu plus compliqu√© que √ßa‚Ä¶ surtout les fuseaux horaires.

## Pourquoi les fuseaux horaires c'est compliqu√©

Voici la terre

(affichage mapemonde 3D)

Et sa repr√©sentation "plane"

(transition vers une carte du monde)

Depuis des mil√©raires (TOCHECK), on consid√©re que "midi", c'est quand le soleil est √† l'√©quinoxe (le plus haut dans le ciel). Ca correspond plus ou moins √† la moiti√© d'une journ√©e (mid-day), et son petit copain minuit (mi-nuit) permet d'avoir le milieu de la nuit.

Sauf que "midi" √† Paris, ce n'est pas la m√™me chose que "midi" √† Tahiti, ni √† Lyon d'ailleurs !

Jusqu'a √† la fin du 19√®me si√®cle, chaque ville avait son heure locale (vu qu'un d√©finissait l'heure grace au soleil, c'est le cadran solaire qui d√©finissait l'heure de chaque ville, normal). Avec l'essort des transports, en particulier du train, avoir une heure par ville, ce n'est **vraiment** pas pratique : aux Etats-Unis, chaque compagnie f√©roviaire utilisait son propre syst√®me de mesure du temps, bas√© sur son si√®ge social ou un terminus important. La gare centrale de Pittsburg, partag√©e par plusieurs compagnie, utilisait six heure diff√©rentes !

En 1858, le math√©maticien Quirico Filopanti posa les bases d'un syst√®me universel. Puis en 1876, en se basant sur les travaux de Filopanti, le g√©ographe Sandford Fleming proposa le syst√®me actuel, bas√© sur le m√©ridien de Greenwich, dans la banlieue de Londres. Le syst√®me est adopt√© en 1884 lors de la conf√©rence internationale du M√©ridien.

### Les fuseaux horaires par pays

Il y a 24h dans une journ√©e, on a donc d√©coup√© la terre en 24 portions √©gales pour cr√©er des fuseaux horaires : l'heure "UTC" du m√©ridien de Greenwich, jusqu'√† UTC-11 √† l'ouest, et UTC+12 √† l'est. Malin l'humain ! (meme avec le black "malin")

(affichage carte avec "tranches")

Enfin √©gales‚Ä¶ c'est quand m√™me plus pratique d'avoir le m√™me fuseau horaire quand on est dans le m√™me pays.

(affichage avec vrai fuseaux horaires)

Enfin dans un m√™me pays‚Ä¶ si il n'est pas trop grand. USA 4 fuseaux horaires, Russie : 11 fuseaux horaires, France : 14 fuseaux horaires (d√©j√† 3 pour la Polyn√©sie Fran√ßaise) !
(affichage des cartes une par une ou aggrandissement, ou coloration)

Bon il y a quand m√™me des pays ou c'est simple. La Chine : un seul fuseaux horaires.

Sauf que du coup c'est le bordel :

- A l'ouest de la chine on se couche √† minuit quand √† l'est on se couche √† 20h
- Les Ouigour (√† l'ouest) utilisent chez eux leur propre heure, non officielle, par dissidence avec le r√©gime en place.

### Les TZ chelou

En parlant de rebelles : chaque pays choisi √† quel fuseau horaire il se "raccroche". Il sagit g√©n√©ralement un d√©callage d'heure enti√®res compar√© √† UTC‚Ä¶ mais parfois :

- Iran : UTC+3:30,
- Afghanistan : UTC+4:30,
- Australie centrale : UTC+10:30
- Inde et Sri Lanka : UTC+5:30
- N√©pal : UTC+5:45 ! üòµ‚Äçüí´

Un autre genre de rebelle vis-√†-vis du syst√®me actuel :

Pour faciliter la communication avec l'ensemble de ses iles, qui se trouvent des deux c√¥t√© de la ligne du changement de date, l'√©tat du Kiribati applique les fuseaux horaires UTC+12, mais aussi UTC+13 et UTC+14 (zoom carte ?)

Au total, de 24 on est pass√© √† 37 fuseaux horaires !

## Tout est politique (ou √©conomique) !

### Cocorico

Revenons en 1884 un moment. Etaient propos√©s comme m√©ridien de r√©f√©rence le m√©ridient de Greenwich, dans la banlieue de Londres, ou le m√©ridien de Paris.
En 1884, quand on est la Grande Bretagne, on g√®re un empire qui repr√©sente _en gros_ un quart des habitants de la plan√®te. On a aussi un copain qui s'appelle les Etats-Unis, qui p√®se un peu dans "le Game" √† l'international. Les deux r√©unis repr√©sentent les deux tiers de la flotte mondiale. Pas trop compliqu√© d'imposer son m√©ridien.
En contre-partie, pour faire plaisir, la Grande Bretagne accepte de passer au syst√®me m√©trique. Et les Etats-Unis ? (meme "mothing to do here")

Les fran√ßais ? Et bien ils ont le seum ! (photo de Laura "trop d√©g")

La France mettrons pr√™t de 30 ans √† accepter le m√©ridien de Greenwich, et c'est le 9 mars 1911 que le texte de loi est enfin accept√©. L'heure l√©gale √©tant donc : ¬´ l'heure du temps moyen de l'observatoire de Paris retard√©e de 9 minutes 21 secondes ¬ª (faut pas d√©conner et laisser gagner les anglais !).

OK, mais‚Ä¶ on est plus sur UTC aujourd'hui, si ?

Avan√ßons un peu dans le temps : nous sommes en juin 1940. L'arm√©e allemande occupe la France, et impose l'heure Allemande en France. Heure qui, bien que remise en question, ne sera pas abandonn√©. (carte)

Par sympathie pour Hitler, l'Espagne de Franco passe aussi √† l'heure allemande en 1942. (carte)

### Samoa

En 2011, les Samoa ont purement et simpplement supprim√© le 30 d√©cembre ! L'Australie et la Nouvelle-Z√©lande √©tant ses partenaires commerciaux principaux, ils ont d√©cid√© de passer de UTC-11 √† UTC+13, et pour ce faire ils ont du supprimer un jour.

Ils avaient fait le changement inverse le 4 juillet 1892, les Etats-Unis √©tant leur partenaire commercial de l'√©poque ! Le 4 juillet (f√™te nationale des Etats Unis) a donc dur√©‚Ä¶ deux jours !

### Conclusion politique

**D'accord**, donc tout est politique ou √©conomique voila pourquoi c'est le bordel (Image Xavier Auberge espagnole ?) ! Tout change tout le temps en fonction des gouvernements ou pour des raisons de gros sous !

## DST

A oui, j'avais oubli√© le DST. Encore un bazar li√© √† l'√©conomie. Le DST c'est l'heure d'√©t√© (Daylight Saving Time). Pour √©viter le ¬´ gaspillage de la lumi√®re ¬ª, au XX√®me si√®cle, on d√©cide de se d√©caller les horloges d'une heure entre mars et octobre.
Dans les faits, en 2009, l'√©conomie r√©alis√©e est estim√©e √† 0,015 % de la consommation √©nerg√©tique : on a baiss√© la consommation d'√©clairage, et on consomme bien plus au global.

Avec l'heure d'√©t√©, on passe de 37 √† 43 fuseaux horaires.

Et l√† encore, beaucoup de politique, et beaucoup de changement dans le temps.

### En France

La France met en place l'heure d'√©t√© en 1916, puis l'abandonne en 1945. On le remet en place en 1976 "temporairement" apr√®s la crise p√©troli√®re. En 1996, pour s'harmoniser avec l'union Europ√©enne, on a chang√© le jour du passage √† l'heure d'hiver.

Enfin je dis en France, mais dans les d√©partements et collectivit√©s d'outre-mer, on ne passe pas √† l'heure d'√©t√©‚Ä¶ sauf √† Saint-Pierre-et-Miquelon qui change d'heure en m√™me temps que‚Ä¶ les Etats-Unis ! (et oui, √©conomiquement c'est plus pratique)

### En Europe

Depuis 2019, dans l'Union Europ√©enne, chaque pays peut supprimer le changement d'heure. Seulement par manque de consensus, chaque pays peut choisir si il reste en heure d'hiver ou en heure d'√©t√©.

La France √©tant plus fan de l'heure d'√©t√©, il pourrait √™tre 14h √† Paris, quand il est 13h en Allemagne, pourtant plus √† l'Est ! ü§¶

Le COVID ayant un peu prit le dessus, en 2022, aucune d√©cision n'a √©t√© prise.

### Etats-Unis

Aux Etats-Unis, chaque √©tat est libre d'appliquer l'heure d'√©t√©, ce que font tous les √©tats sauf Hawa√Ø et l'Arizona : en √©t√©, en allant de Los Angeles √† Phoenix on ne change pas d'heure, mais on change d'heure en hiver.

### Australie

La palme du bazar revient √† l'Australie.
L'Australie est coup√© en trois fuseaux horaires en hiver :

- UTC+8 √† l'Ouest,
- UTC+10 √† l'Est,
- UTC+9:30 au centre üòñ

En √©t√© certains √©tats, mais pas tous, passent √† l'heure d'√©t√©. On se retrouve donc avec :

- √† l'ouest : UTC+8,
- au centre nord : UTC+9:30,
- au centre sud : UTC+10:30,
- au nord est : UTC+10:00,
- au sud est : UTC+11

On peut donc ¬´ revenir dans le temps ¬ª simplement en voyageant du sud au nord !

## C√¥t√© informatique, √ßa donne quoi tout √ßa ?

Et oui, en informatique, comment on fait pour g√©rer tout ce bazar exactement ?

### La (les ?) normes

En informatique, on aime bien les normes. C'est un peu comme les lois : √ßa permet √† tout le monde de se comprendre.

**La** norme sur la gestion des dates, c'est la norme ISO 8601 ("Repr√©sentation de la date et l'heure"), et pour la standardisation des dates en informatique en particulier, son "profil" RFC3339.

En ISO 8601, une date ressemble √† √ßa :

`2022-11-19T22:27:00+01:00`

Ann√©e-Mois-Jour T(ime) Heure:minute:seconde d√©callage UTC.

OK. Le d√©callage UTC c'est cool. Enfin disons que c'est d√©j√† √ßa. Mais pourtant on l'a vu : entre l'heure d'√©t√© et les changements √† travers le temps, on ne peut pas travailler avec des dates de fa√ßon pr√©cise si l'on n'a pas le fuseau horaire exact : si vous √™tes √† UTC-7 en √©t√©, quel heure sera-t-til dans 6 mois ? Impossible √† savoir sans savoir si vous parlez de l'heure de Phoenix ou bien l'heure de Los Angeles.

Mais du coup c'est quoi le standard des fuseaux horaires ?

Et bien il n'y en a pas ! Enfin pas encore tout du moins. Il y a une proposition pour √©tendre la RFC3339 afin de pouvoir ajouter le fuseau horaire dans le format: 2022-11-19T22:27:00+01:00[Europe/Paris].

Le format est en parti dict√© par l'impl√©mentation JavaZDT qui est tr√®s utilis√©e. Mais cela ne fonctionne pas en PHP par example !

D'ailleurs il n'y a m√™me pas de "liste officielle des fuseaux horaires". C'est souvent la liste du IANA (Internet Assigned Numbers Authority), qui g√®re les DNS et les adresses IP, entre autre, et qui maintient une liste √† jour des fuseaux horaires, qui est utilis√©e.

### Les langages

#### PHP

Clairement en PHP, c'est la meilleure API de gestion de date avec laquelle j'ai pu travailler, notamment pour la gestion des constructeurs / modificateurs en anglais (`new DateTime('next monday 10:00 Europe/Paris')` fonctionne !).

La librairie standard est suffisante pour faire √©normement.

Ne g√®re malheureusement pas le format non standard JavaZDT.

[php.net/datetime](https://www.php.net/datetime)

#### Java

Ca a l'air plut√¥t tr√®s bien g√©r√©, des classes pour g√©rer les DateTime, les Calendar, les TimeZone avec les heures d'√©t√©, etc. (c'est pour cela que la norme est fortement inspir√©e de JavaZDT)

[documentation de Date](https://docs.oracle.com/javase/7/docs/api/java/util/Date.html)

#### Python

C'est fonctionnel, mais pas top, surtout la gestion des timezones qui fonctionne pas ou mal sous Windows.

- [SPL zoneinfo](https://docs.python.org/3/library/zoneinfo.html#data-sources)
- [dateutil tzwin](https://dateutil.readthedocs.io/en/stable/tzwin.html)

#### Ruby

> DateTime does not consider any leap seconds, does not track any summer time rules.

Ca ne sent pas tr√®s bon d√®s le d√©part ! Mais [la documentation](https://ruby-doc.org/stdlib-2.6.1/libdoc/date/rdoc/DateTime.html) montre que c'est le bordel d√®s d'entr√©e.

La doc termine comme √ßa :

> If you also have to deal with timezones then best of luck - just bear in mind that you'll probably be dealing with local solar times, since it wasn't until the 19th century that the introduction of the railways necessitated the need for Standard Time and eventually timezones.

#### Javascript

Pire librairie possible : API pas pratique, sujette √† l'erreur, inconsistante :

```js
d = new Date()
>> Date Mon Nov 21 2022 23:14:30 GMT+0100 (heure normale d‚ÄôEurope centrale)

d.getDay() // en fait : day of week
>> 1
d.getDate() // day ?
>> 21
d.getMonth() // 0-index√©
>> 10
```

MomentJS, par contre est super puissant: API top et super simple a utili√©.

`moment-timezone` fait 1 Mo de donn√©e (112Ko gzipp√©) par contre !

Remplac√© par luxon, day.js, etc. et surtout par [Temporal](https://tc39.es/proposal-temporal/docs/index.html), actuellement stage 3. Temporal se base sur le format JavaZDT pour l'affichage des fuseaux horaires.

### SQL : attention la gal√®re

#### Comment les DB g√®rent les TimeZones ?

> le standard SQL poss√®de un **m√©lange √©trange** de types de date/heure et de possibilit√©s.

_[la documentation de Postgresql](https://docs.postgresql.fr/10/datatype-datetime.html#DATATYPE-TIMEZONES)_

En SQL, il y a un fuseau horaire d√©fini sur le serveur (comme en PHP par exemple).
On peut aussi modifier sa TimeZone pour la dur√©e de sa session.

Un petit test rapide, de ce que √ßa donne.

```sql
SET time_zone = 'America/Phoenix';
INSERT INTO test VALUES (5, '2022-11-24T12:00:00');
SELECT * FROM test WHERE id = 5;

# 2022-11-24 12:00:00

SET time_zone = 'Europe/Paris';

SELECT * FROM test WHERE id = 5;

# 2022-11-24 12:00:00
```

dafuk ?! On ins√®re une donn√©e locale, mais elle reste locale, m√™me si on change la timezone de la session.

On peut cela dit convertir depuis une TZ vers une autre :

- MySQL / MariaDB : `CONVERT_TZ(datetime, from_tz, to_tz)`
- SQLServer : `datetime AT TIME ZONE to_TZ`
- Postgresql : AT TIMEZONE (?) ou bien datetime::timestamptz

Si j'ai bien compris, on utilise la valeur de la session et pas la valeur de la donn√©e. Dans Postgresql par exemple, la donn√©e est juste convertie pour √™tre stock√©e en UTC.

De tout fa√ßon, le retour de donn√©e contient seulement un d√©callage √† UTC, mais pas le fuseau horaire.

#### Comment on stocke la donn√©e ?

| value               | timezone     |
| ------------------- | ------------ |
| 2022-11-25T12:00:00 | Europe/Paris |

Deux fa√ßons de faire :

- Je stocke l'heure locale de la donn√©e
- Je stocke l'heure UTC de la donn√©e (et il est donc 13h heure de Paris)

Pro heure locale :

- Si la loi change, la donn√©e reste valide‚Ä¶ enfin si la donn√©e ne concerne pas des √©changes internationaux.
- Facilit√© de debug (la valeur est humainement lisible, pas besoin d'ajouter / soustraire pour avoir la "vrai" heure)

Pro heure UTC :

- Permet de comparer des dates sur des fuseaux horaires diff√©rents (pour trier par example).
- Plus g√©n√©ralement, met la repr√©sentation des dates sur la "vrai" ligne temporelle.
- Evite les probl√®mes avec l'heure d'√©t√© : le 30 octobre 2022 en France, les horloges passeront deux fois entre 2 h et 3 h. Impossible donc de savoir si c'est 2 h UTC+1 ou bien 2h UTC+2. Cela dit cela complexifie aussi pas mal la gestion.

Le dernier point fait qu'il est consid√©r√© comme une bonne pratique de toujours stocker la valeur UTC d'une date.

### Et dans une API ?

C'est un peu le m√™me combat que pour SQL, mais avec plus de flexibilit√©.

On peut √† minima travailler avec la RFC3339 et avoir un format `2022-11-25T12:00:00+01:00`. Cela dit, vu que l'on n'a pas le fuseau horaire, il est toujours impossible de "bouger" dans le temps sans se tromper sur l'heure d'√©t√©.

Utiliser le format JavaZDT ? Pourquoi pas‚Ä¶ sauf qu'aujourd'hui les librairies ne reconnaissent pas toute cette information.

Si vous travaillez juste pour de l'affichage, avoir le format RFC3339 est suffisant. Si vous voulez travailler sur de la donn√©e, alors le mieux est surement d'avoir deux cl√©s :

```json
{
  "value": "2022-11-25T12:00:00+01:00",
  "timezone": "Europe/Paris"
}
```

### Le bug de 2038

![bug de 2038](https://imgs.xkcd.com/comics/y2k_and_2038.png)

En informatique, les dates sont repr√©sent√©es par des "timestamp" : le nombre de secondes √©coul√©es depuis le 1er janvier 1970.

Hors le 19 janvier 2038 √† 3¬†h¬†14¬†min¬†7¬†s, on va d√©passer la taille maximale de stockage d'un nombre entier sur les syst√®mes 32 bits. On va "boucler", et revenir‚Ä¶ le 13 d√©cemble 1901 (un timestamp de `‚àí2 147 483 648`).

En PHP 8.0, la gestion des heures d'√©t√© √©tait impact√©e par ce bug (corrig√© en 8.1). A Mapado on n'avait pas v√©rifi√© la donn√©e r√©elle de notre stack de tests, et nos √©v√®nements de tests en 2100 avait une mauvaise repr√©sentation. Le passage a php 8.1 a fait plant√© la stack de tests !

## La vie, l'univers et le reste

OK donc on a vu que c'√©tait bien le bazar.

Et encore, je ne vous ai pas parl√© des secondes intercallaires, ces secondes qui sont ajout√©e pour ajuster le temps UTC aux variations de vitesses de rotation de la terre.

Mais finalement les humains se sont quand m√™me coordonn√©s sur la plan√™te pour avoir un temps universel‚Ä¶ universel ? terrestre plut√¥t !

Que va-t-il se passer quand on aura colonis√© la Lune ou Mars ? Va-t-on garder "UTC" comme r√©f√©rence ? Peu probable, tout comme on a abandonn√© les heure locale, il y aura probablement un temps "solaire". Et plus tard ? Un temps de la Galaxie ?

On consid√®re que l'on est sur une "ligne temporelle", mais on est a peu pr√™t s√ªrs que le temps est "√©tir√©" √† l'approche d'un trou noir. L√† encore, comment g√©rer la conversion ? Est-ce les m√™me valeurs qui s'√©coulent juste moins vite ?

### One more brainfuck

![timezone in antartica](https://lesjoiesducode.fr/content/046/antarctique-fuseaux.webp)

L'antartique : ce continent inhabit√© dans lequel cohabitent‚Ä¶ 12 fuseaux horaires diff√©rents !

L'antartique n'est pas officiellement divis√©e en fuseau horaires. Cela dit, le continent a √©t√© divis√© en territoires, pour lesquels le fuseau horaire correspond soit √† celui du pays auquel ils appartiennent, soit √† celui du pays qui les approvisionne.

Certaines base scientifiques se sont l√¢ch√©es en plus de √ßa :

- Alors que le changement d'heure n'est pas appliqu√© sur la majeure partie du continent, la station de recherche Palmer, d√©tenue et financ√©e par les √âtats-Unis, mais exploit√©e sur le territoire chilien, suit l'heure du Chili.
- La station Troll, situ√©e dans une zone revendiqu√©e par la Norv√®ge, suit le temps universel (UTC) d'octobre √† mars, puis passe en UTC+2 (WTF) de mars √† octobre. (Elle porte tr√®s bien son nom.)

En compl√©ment, des chercheurs travaillant dans la station d'un autre pays que le leur optent parfois pour suivre le fuseau horaire de leur pays d'origine, du moment qu'ils n'ont pas √† travailler avec d'autres √©quipes, cela facilitant les communications avec leur maison m√®re.
